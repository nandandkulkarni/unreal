# Motion System - AI Developer Guide

This document is designed to help AI agents and developers quickly understand the Motion System project, its architecture, and how to work with it.

## üéØ Project Overview

**Goal:** Procedurally generate motion and camera animation in Unreal Engine using Python.
**Key Features:**
- Convert high-level commands (e.g., "move forward 5m", "turn 90 degrees") into Level Sequence keyframes.
- Support for Mannequin characters and Cine Cameras.
- Integrated testing framework with detailed verification and logging.
- Remote execution architecture to control Unreal Engine from external python scripts.

---

## üèó Architecture & Execution Model

This project uses a **Split Execution Model** to handle Unreal Engine's specific Python environment constraints.

### 1. The Challenge
Unreal Engine's Python environment:
- Is embedded inside the Editor process.
- Can be accessed via "Remote Control" HTTP requests.
- Does not persist state between separate `ExecutePythonCommand` calls unless specifically managed.
- Does **not** support `__file__` or standard relative paths reliably during remote execution.

### 2. The Solution: Runner vs. Script
We separate code into valid "Runners" (local Python) and "Scripts" (Unreal Python).

*   **üèÉ Runner (`tests/trigger_*.py`)**
    *   Runs on the local machine (Windows).
    *   Reads the content of a target *Script* file.
    *   Sends the script content to Unreal Engine via HTTP PUT request to port `30010`.
    *   *Example:* `tests/trigger_integrated_test.py`

*   **üìú Script (`tests/run_*.py` or `tests/*_script.py`)**
    *   Executed **inside** Unreal Engine.
    *   Imports `motion_system` modules.
    *   Performs the actual work: spawning actors, creating sequences, applying keyframes.
    *   **Crucial:** Must use absolute paths or hardcoded paths for imports, as `__file__` is undefined.
    *   *Example:* `tests/run_integrated_test.py`

---

## üó∫ Key Locations

| Directory | Content |
| :--- | :--- |
| **`motion_system/`** | Core logic (`motion_planner`, `keyframe_applier`), utilities (`cleanup`, `logger`), and the database (`debug_db.py`). |
| **`motion_system/tests/`** | Test runners and scripts. This is where you run verifying code. |
| **`docs/`** | Documentation. |
| **`output/`** | Logs and artifacts generated by tests. check `troubleshooting_log_*.txt` here. |

### üîç Unreal Python API Reference
A text-based API reference specifically generated for this project's needs (Sequencer, Camera, etc.) can be found here:

`c:\UnrealProjects\Coding\unreal\docs\api_reference.txt`

**Use this file to:**
- Look up available methods on `CineCameraActor`, `LevelSequence`, `MovieScene3DTransformTrack`, etc.
- Check property names (e.g., snake_case vs PascalCase).

---

## üõ† Common Workflow & Patterns

### 1. Adding a New Motion Command
1.  **Update `motion_planner.py`**: Add a `process_NEW_COMMAND` function and register it in `plan_motion`.
2.  **Update `run_motion_tests.py`**: Add a new test case dictionary to `TEST_CASES`.
3.  **Run Verification**: Execute `python tests/trigger_motion_tests.py`.

### 2. Developing & Debugging
- **Reloading:** The test scripts include extensive `importlib.reload(module)` calls. This is intentional. It allows you to edit core modules (`motion_planner.py`) and immediately re-run the test without restarting Unreal.
- **Paths:** Always use **Absolute Paths** or hardcoded paths found in `sys.path`.
    ```python
    # BAD
    import my_module 
    
    # GOOD
    sys.path.append(r"C:\UnrealProjects\Coding\unreal")
    from motion_system import my_module
    ```
- **Vector Math:** Unreal uses `unreal.Vector(x, y, z)` and `unreal.Rotator(pitch, yaw, roll)`.
    - *Note:* The `motion_planner` often uses simple dictionaries `{'x': 0, 'y': 0, 'z': 0}` for calculation ease, then converts to `unreal.Vector` in `keyframe_applier`.
- **Coordinate System:** Unreal is **Left-Handed, Z-Up**.
    - X = Forward
    - Y = Right
    - Z = Up

### 3. Database & Logs
- **`motion_debug.db`**: SQLite database storing every test run, command, and keyframe.
- **Querying:** Use `tests/query_debug_db.py` to inspect valid/invalid runs.

---

## ‚ö†Ô∏è Known Constraints
1.  **No User Input:** Scripts running in Unreal cannot accept console input.
2.  **Blocking:** Long-running scripts will freeze the Unreal Editor UI until completion.
3.  **Dependencies:** External Python libraries (like `numpy`) usually work if installed in the engine's python environment, but prefer standard library/Unreal API where possible.
